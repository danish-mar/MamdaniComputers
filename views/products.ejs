<%# layout('layout') removed because it's handled in app.js %>

    <div x-data="{ 
    search: '',
    priceRange: 250000,
    sortOrder: 'newest',
    activeCategories: [],
    categories: [],
    products: [],
    loading: true,
    
    async init() {
        try {
            this.products = await ProductsFetcher.getProducts();
            const categoryNames = this.products.map(p => p.category?.name || p.category);
            this.categories = [...new Set(categoryNames.filter(Boolean))];
        } catch (error) {
            console.error('Error loading products:', error);
        } finally {
            this.loading = false;
        }
    },
    showMobileFilters: false,
    
    get filteredProducts() {
        let filtered = this.products.filter(p => {
            const matchesSearch = p.name.toLowerCase().includes(this.search.toLowerCase());
            const matchesPrice = p.price <= this.priceRange;
            const catName = p.category?.name || p.category;
            const matchesCategory = this.activeCategories.length === 0 || this.activeCategories.includes(catName);
            return matchesSearch && matchesPrice && matchesCategory;
        });

        if (this.sortOrder === 'price-low') {
            filtered.sort((a, b) => a.price - b.price);
        } else if (this.sortOrder === 'price-high') {
            filtered.sort((a, b) => b.price - a.price);
        } else {
            // Newest by default
            filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }

        return filtered;
    },

    toggleCategory(cat) {
        if (this.activeCategories.includes(cat)) {
            this.activeCategories = this.activeCategories.filter(c => c !== cat);
        } else {
            this.activeCategories.push(cat);
        }
    }
}" class="pt-24 pb-24 dark:bg-black transition-colors duration-500 min-h-screen">


        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Header Section -->
            <div
                class="flex flex-col md:flex-row justify-between items-start md:items-end gap-8 mb-16 reveal-on-scroll">
                <div>
                    <h1 class="text-4xl md:text-5xl font-black text-apple-dark dark:text-white mb-4">Catalog.</h1>
                    <p class="text-xl text-gray-400 font-light">The complete collection of professional hardware.</p>
                </div>
                <div class="w-full md:w-auto flex items-center gap-4">
                    <div class="relative flex-1 md:w-72">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" x-model="search" placeholder="Search tech..."
                            class="w-full pl-12 pr-6 py-3 bg-white dark:bg-[#1c1c1e] border border-gray-100 dark:border-white/5 rounded-full focus:ring-2 focus:ring-apple-blue focus:border-transparent transition-all shadow-sm dark:text-white">
                    </div>
                    <button @click="showMobileFilters = true"
                        class="md:hidden w-12 h-12 flex items-center justify-center bg-white border border-gray-100 rounded-full text-apple-dark">
                        <i class="fas fa-filter"></i>
                    </button>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-12">
                <!-- Sidebar Filters (Desktop) -->
                <aside class="hidden lg:block w-64 space-y-10 shrink-0 reveal-on-scroll">
                    <!-- Categories -->
                    <div>
                        <h3 class="text-sm font-bold tracking-widest uppercase text-gray-400 mb-6">Categories</h3>
                        <div class="space-y-4">
                            <template x-for="cat in categories">
                                <label class="flex items-center group cursor-pointer">
                                    <div class="relative flex items-center">
                                        <input type="checkbox" @change="toggleCategory(cat)"
                                            :checked="activeCategories.includes(cat)" class="peer sr-only">
                                        <div
                                            class="w-5 h-5 border-2 border-gray-200 rounded-md group-hover:border-apple-blue transition-colors peer-checked:bg-apple-blue peer-checked:border-apple-blue flex items-center justify-center">
                                            <i
                                                class="fas fa-check text-[10px] text-white opacity-0 peer-checked:opacity-100"></i>
                                        </div>
                                        <span
                                            class="ml-3 text-gray-600 group-hover:text-apple-dark transition-colors font-medium"
                                            x-text="cat"></span>
                                    </div>
                                </label>
                            </template>
                        </div>
                    </div>

                    <!-- Price Range -->
                    <div>
                        <h3 class="text-sm font-bold tracking-widest uppercase text-gray-400 mb-6">Max Price</h3>
                        <div class="space-y-4">
                            <input type="range" x-model="priceRange" min="0" max="250000" step="1000"
                                class="w-full accent-apple-blue">
                            <div class="flex justify-between text-sm font-bold text-apple-dark">
                                <span>₹0</span>
                                <span x-text="'₹' + parseInt(priceRange).toLocaleString('en-IN')"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Sorting -->
                    <div>
                        <h3 class="text-sm font-bold tracking-widest uppercase text-gray-400 mb-6">Sort By</h3>
                        <select x-model="sortOrder"
                            class="w-full bg-white border border-gray-100 rounded-xl px-4 py-3 text-apple-dark font-medium focus:ring-2 focus:ring-apple-blue transition-all outline-none">
                            <option value="newest">Newest Arrivals</option>
                            <option value="price-low">Price: Low to High</option>
                            <option value="price-high">Price: High to Low</option>
                        </select>
                    </div>
                </aside>

                <!-- Product Grid -->
                <main class="flex-1">
                    <!-- Loading State -->
                    <div x-show="loading" class="py-32 text-center">
                        <div class="flex justify-center items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-apple-blue rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                            <div class="w-3 h-3 bg-apple-blue rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                            <div class="w-3 h-3 bg-apple-blue rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                        </div>
                        <p class="text-gray-400 text-lg font-medium">Loading products...</p>
                    </div>

                    <div x-show="!loading" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-8">
                        <template x-for="product in filteredProducts" :key="product.id">
                            <a :href="'/product/' + product.id" class="bento-card flex flex-col cursor-pointer group block">
                                <div class="aspect-square overflow-hidden bg-apple-gray relative rounded-t-[2rem]">
                                    <img :src="product.images?.[0] || 'https://via.placeholder.com/800x800?text=No+Image'" :alt="product.name"
                                        class="w-full h-full object-cover rounded-t-[2rem] transition-transform duration-700 group-hover:scale-105">
                                    <div class="absolute top-4 right-4">
                                        <span x-text="product.isSold ? 'Sold' : 'Available'"
                                            :class="product.isSold ? 'bg-apple-dark text-white' : 'bg-apple-blue text-white'"
                                            class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest"></span>
                                    </div>
                                </div>
                                <div class="p-6 flex flex-col flex-1">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest"
                                            x-text="product.category?.name || product.category"></span>
                                        <span class="text-lg font-bold text-apple-dark dark:text-white"
                                            x-text="'₹' + product.price.toLocaleString('en-IN')"></span>
                                    </div>
                                    <h3 class="text-xl font-bold text-apple-dark dark:text-white mb-2"
                                        x-text="product.name"></h3>
                                    <p class="text-sm text-gray-500 line-clamp-2 mb-6" x-text="product.description || 'Professional grade hardware.'"></p>
                                    <div class="mt-auto flex items-center text-apple-blue font-bold text-sm">
                                        Details <i
                                            class="fas fa-chevron-right ml-2 text-xs transition-transform group-hover:translate-x-1"></i>
                                    </div>
                                </div>
                            </a>
                        </template>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!loading && filteredProducts.length === 0" class="py-32 text-center reveal-on-scroll">
                        <div
                            class="w-20 h-20 bg-apple-gray rounded-full flex items-center justify-center mx-auto mb-6 text-gray-300 text-3xl">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-apple-dark mb-2">No results found</h3>
                        <p class="text-gray-400">Try adjusting your filters or search terms.</p>
                        <button @click="search = ''; activeCategories = []; priceRange = 3000"
                            class="mt-8 text-apple-blue font-bold hover:underline">Clear all filters</button>
                    </div>
                </main>
            </div>
        </div>

        <!-- Mobile Filters Overlay -->
        <div x-show="showMobileFilters" class="fixed inset-0 z-[100] lg:hidden"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100" x-cloak>
            <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" @click="showMobileFilters = false"></div>
            <div class="absolute bottom-0 inset-x-0 bg-white dark:bg-[#1c1c1e] rounded-t-[2.5rem] p-8 max-h-[90vh] overflow-y-auto"
                x-transition:enter="transition ease-out duration-300 translate-y-full"
                x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0">
                <div class="flex justify-between items-center mb-10">
                    <h2 class="text-2xl font-bold text-apple-dark dark:text-white">Filters</h2>
                    <button @click="showMobileFilters = false"
                        class="w-10 h-10 flex items-center justify-center bg-apple-gray rounded-full text-apple-dark">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="space-y-12 pb-10">
                    <!-- Mobile Categories -->
                    <div>
                        <h3 class="text-xs font-bold tracking-widest uppercase text-gray-400 mb-6">Categories</h3>
                        <div class="flex flex-wrap gap-3">
                            <template x-for="cat in categories">
                                <button @click="toggleCategory(cat)"
                                    :class="activeCategories.includes(cat) ? 'bg-apple-blue text-white' : 'bg-apple-gray text-gray-600'"
                                    class="px-6 py-3 rounded-full text-sm font-bold transition-all"
                                    x-text="cat"></button>
                            </template>
                        </div>
                    </div>

                    <!-- Mobile Price -->
                    <div>
                        <h3 class="text-xs font-bold tracking-widest uppercase text-gray-400 mb-6">Max Price</h3>
                        <input type="range" x-model="priceRange" min="0" max="250000" step="1000"
                            class="w-full accent-apple-blue h-2 rounded-lg appearance-none bg-gray-200">
                        <div class="flex justify-between text-lg font-bold text-apple-dark mt-4">
                            <span>₹0</span>
                            <span x-text="'₹' + parseInt(priceRange).toLocaleString('en-IN')"></span>
                        </div>
                    </div>

                    <!-- Mobile Sort -->
                    <div>
                        <h3 class="text-xs font-bold tracking-widest uppercase text-gray-400 mb-6">Sort By</h3>
                        <div class="grid grid-cols-1 gap-3">
                            <button @click="sortOrder = 'newest'"
                                :class="sortOrder === 'newest' ? 'border-apple-blue text-apple-blue bg-blue-50' : 'border-gray-100 text-gray-600'"
                                class="px-6 py-4 rounded-2xl border-2 text-left font-bold transition-all text-sm">Newest
                                Arrivals</button>
                            <button @click="sortOrder = 'price-low'"
                                :class="sortOrder === 'price-low' ? 'border-apple-blue text-apple-blue bg-blue-50' : 'border-gray-100 text-gray-600'"
                                class="px-6 py-4 rounded-2xl border-2 text-left font-bold transition-all text-sm">Price:
                                Low to High</button>
                            <button @click="sortOrder = 'price-high'"
                                :class="sortOrder === 'price-high' ? 'border-apple-blue text-apple-blue bg-blue-50' : 'border-gray-100 text-gray-600'"
                                class="px-6 py-4 rounded-2xl border-2 text-left font-bold transition-all text-sm">Price:
                                High to Low</button>
                        </div>
                    </div>

                    <div class="pt-6">
                        <button @click="showMobileFilters = false"
                            class="w-full py-5 bg-apple-dark text-white rounded-2xl font-bold text-lg">Apply
                            Filters</button>
                        <button
                            @click="search = ''; activeCategories = []; priceRange = 3000; showMobileFilters = false"
                            class="w-full mt-4 py-3 text-gray-400 font-bold text-sm">Reset All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        [x-cloak] {
            display: none !important;
        }
    </style>